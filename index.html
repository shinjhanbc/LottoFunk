import React, { useState, useEffect, useMemo } from 'react';
import { Sparkles, Zap, RefreshCw, Copy, TrendingUp, Snowflake, Layers, Shuffle, DollarSign, BrainCircuit, MessageSquareText, X } from 'lucide-react';

// --- Gemini API Configuration ---
const apiKey = ""; // Runtime will provide the key

// --- æ¨¡æ“¬æ•¸æ“šèˆ‡æ ¸å¿ƒé‚è¼¯ ---

const generateMockFrequency = (maxNumber) => {
  const freqMap = [];
  for (let i = 1; i <= maxNumber; i++) {
    const randomWeight = Math.random() * 100 + (Math.random() > 0.8 ? 50 : 0);
    freqMap.push({ number: i, frequency: Math.floor(randomWeight) });
  }
  return freqMap.sort((a, b) => b.frequency - a.frequency);
};

// éŠæˆ²è¨­å®š
const GAMES = {
  BIG_LOTTO: {
    name: 'å¤§æ¨‚é€',
    zone1: 49,
    zone2: 0,
    pick1: 6,
    color: 'from-yellow-400 to-orange-500'
  },
  SUPER_LOTTO: {
    name: 'å¨åŠ›å½©',
    zone1: 38,
    zone2: 8,
    pick1: 6,
    pick2: 1,
    color: 'from-pink-500 to-purple-600'
  }
};

// é¸è™Ÿç­–ç•¥
const STRATEGIES = [
  { id: 'hot', name: 'ğŸ”¥ ç†±é–€å‰20 (éš¨æ©Ÿ)', icon: TrendingUp },
  { id: 'mix', name: 'ğŸŒ— å†·ç†±å„åŠ', icon: Layers },
  { id: 'mid', name: 'â– ä¸­æ®µç­ (15-35å)', icon: Shuffle },
  { id: 'cold', name: 'ğŸ§Š å…¨å†·é–€è™Ÿ', icon: Snowflake },
];

// ç”Ÿæˆæ¨¡å¼
const GENERATION_TYPES = {
  BIG_LOTTO: [
    { id: 1, name: 'å–®çµ„è™Ÿç¢¼', count: 1 },
    { id: 2, name: 'å…©çµ„è™Ÿç¢¼', count: 2 },
    { id: 3, name: 'ä¸‰çµ„è™Ÿç¢¼', count: 3 },
    { id: 'system7', name: 'âš¡ 7é€£ç¢° (é¸7ç¢¼)', count: 1, special: true },
  ],
  SUPER_LOTTO: [
    { id: 1, name: 'å–®çµ„è™Ÿç¢¼', count: 1 },
    { id: 2, name: 'å…©çµ„è™Ÿç¢¼', count: 2 },
    { id: 3, name: 'ä¸‰çµ„è™Ÿç¢¼', count: 3 },
    { id: 'pkg700', name: 'ğŸ’° 700å…ƒåŒ…ç‰Œ (7çµ„)', count: 7 },
    { id: 'pkg800', name: 'ğŸ’ 800å…ƒå…¨é¤ (ç¬¬2å€å…¨åŒ…)', count: 1, special: true },
  ]
};

// --- UI Components ---

const NeonButton = ({ children, onClick, active, colorClass = "border-cyan-400 text-cyan-400", className = "" }) => (
  <button
    onClick={onClick}
    className={`
      relative px-4 py-2 font-mono text-sm sm:text-base font-bold transition-all duration-200 uppercase tracking-widest
      border-2 rounded-md hover:scale-105 active:scale-95
      ${active 
        ? `${colorClass} bg-opacity-20 bg-white shadow-[0_0_15px_rgba(255,255,255,0.3)]` 
        : 'border-zinc-700 text-zinc-500 hover:border-zinc-400 hover:text-zinc-300'}
      ${className}
    `}
  >
    {active && <div className={`absolute inset-0 opacity-20 blur-md ${colorClass.replace('border-', 'bg-')}`} />}
    <div className="flex items-center justify-center gap-2 relative z-10">
      {children}
    </div>
  </button>
);

const Ball = ({ num, isSpecial = false, delay = 0 }) => {
  const [show, setShow] = useState(false);

  useEffect(() => {
    const timer = setTimeout(() => setShow(true), delay * 100);
    return () => clearTimeout(timer);
  }, [delay]);

  return (
    <div 
      className={`
        w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center font-black text-lg sm:text-xl transform transition-all duration-500
        ${show ? 'scale-100 opacity-100 rotate-0' : 'scale-0 opacity-0 rotate-180'}
        ${isSpecial 
          ? 'bg-red-600 text-white shadow-[0_0_15px_#ef4444] border-2 border-red-400' 
          : 'bg-zinc-900 text-cyan-300 border-2 border-cyan-500 shadow-[0_0_10px_#06b6d4]'}
      `}
    >
      {String(num).padStart(2, '0')}
    </div>
  );
};

const ResultCard = ({ result, index, gameType }) => {
  const isSuperPkg800 = result.type === 'pkg800';
  const isDream = result.type === 'dream';

  return (
    <div className={`
      bg-zinc-900/80 border p-4 rounded-xl mb-4 relative overflow-hidden group transition-colors
      ${isDream ? 'border-purple-500/50 shadow-[0_0_20px_rgba(168,85,247,0.2)]' : 'border-zinc-700 hover:border-cyan-500/50'}
    `}>
      <div className={`absolute top-0 left-0 w-1 h-full bg-gradient-to-b ${isDream ? 'from-purple-400 to-pink-600' : 'from-cyan-500 to-purple-600'}`} />
      
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3">
        <span className={`font-mono text-xs mb-2 sm:mb-0 ${isDream ? 'text-purple-300' : 'text-zinc-400'}`}>
          {isDream ? 'âœ¨ AI ORACLE PREDICTION' : `TICKET #${String(index + 1).padStart(3, '0')}`}
          {isSuperPkg800 && <span className="ml-2 text-yellow-400 font-bold">[ç¬¬2å€å…¨åŒ…]</span>}
        </span>
      </div>

      <div className="flex flex-wrap gap-3 items-center">
        {result.zone1.sort((a,b) => a-b).map((num, i) => (
          <Ball key={`z1-${i}`} num={num} delay={i} />
        ))}

        {(result.zone2.length > 0) && (
          <div className="w-px h-8 bg-zinc-600 mx-2 hidden sm:block" />
        )}

        {gameType === 'SUPER_LOTTO' && !isSuperPkg800 && result.zone2.map((num, i) => (
          <Ball key={`z2-${i}`} num={num} isSpecial={true} delay={6 + i} />
        ))}
        
        {isSuperPkg800 && (
          <div className="flex gap-1 flex-wrap max-w-[200px]">
             {[1,2,3,4,5,6,7,8].map(n => (
               <span key={n} className="w-6 h-6 rounded-full bg-red-900/50 text-red-300 border border-red-500 flex items-center justify-center text-xs shadow-[0_0_5px_#ef4444]">
                 0{n}
               </span>
             ))}
          </div>
        )}
      </div>

      {/* AI Comment Section */}
      {result.comment && (
        <div className="mt-4 pt-3 border-t border-zinc-700/50">
           <div className="flex gap-2 text-sm text-purple-200 italic font-mono opacity-80">
              <Sparkles className="w-4 h-4 flex-shrink-0 mt-0.5" />
              <p>"{result.comment}"</p>
           </div>
        </div>
      )}
    </div>
  );
};

// --- Main App ---

export default function App() {
  const [activeGame, setActiveGame] = useState('BIG_LOTTO');
  const [strategy, setStrategy] = useState('hot');
  const [genType, setGenType] = useState(1);
  const [results, setResults] = useState([]);
  const [isAnimating, setIsAnimating] = useState(false);
  
  // AI Dream Feature State
  const [showDreamInput, setShowDreamInput] = useState(false);
  const [dreamText, setDreamText] = useState('');
  const [isDreaming, setIsDreaming] = useState(false);
  const [dreamError, setDreamError] = useState('');

  // æ•¸æ“šçµ±è¨ˆ (æ¨¡æ“¬)
  const stats = useMemo(() => ({
    bigLotto: generateMockFrequency(49),
    superLotto1: generateMockFrequency(38),
    superLotto2: generateMockFrequency(8)
  }), []);

  // å–å¾—è™Ÿç¢¼æ± 
  const getPoolByStrategy = (fullStats, countNeeded, currentStrategy) => {
    let pool = [];
    const total = fullStats.length;

    switch (currentStrategy) {
      case 'hot': pool = fullStats.slice(0, 20); break;
      case 'mix': 
        const hotPart = fullStats.slice(0, 20);
        const coldPart = fullStats.slice(total - 20, total);
        pool = [...hotPart, ...coldPart]; 
        break;
      case 'mid': pool = fullStats.slice(14, 35); break;
      case 'cold': pool = fullStats.slice(total - 20, total); break;
      default: pool = fullStats;
    }
    return pool.map(i => i.number);
  };

  const pickRandom = (pool, count) => {
    const shuffled = [...pool].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
  };

  const handleGenerate = () => {
    setIsAnimating(true);
    setResults([]);
    setShowDreamInput(false); // Close dream input if generating normal

    setTimeout(() => {
      const gameConfig = GAMES[activeGame];
      const typeConfig = GENERATION_TYPES[activeGame].find(t => t.id === genType);
      
      const newResults = [];
      const loopCount = typeConfig.count;
      const isSystem7 = activeGame === 'BIG_LOTTO' && genType === 'system7';
      const isPkg800 = activeGame === 'SUPER_LOTTO' && genType === 'pkg800';

      for (let i = 0; i < loopCount; i++) {
        const statSource1 = activeGame === 'BIG_LOTTO' ? stats.bigLotto : stats.superLotto1;
        let pickedZone1 = [];
        
        if (strategy === 'mix') {
            const pickCount = isSystem7 ? 7 : gameConfig.pick1;
            const half = Math.ceil(pickCount / 2);
            const hotPool = statSource1.slice(0, 20).map(x => x.number);
            const coldPool = statSource1.slice(statSource1.length - 20).map(x => x.number);
            const hotPicks = pickRandom(hotPool, half);
            const coldPicks = pickRandom(coldPool, pickCount - half);
            pickedZone1 = [...hotPicks, ...coldPicks];
        } else {
            const pool1 = getPoolByStrategy(statSource1, gameConfig.pick1, strategy);
            pickedZone1 = pickRandom(pool1, isSystem7 ? 7 : gameConfig.pick1);
        }

        let pickedZone2 = [];
        if (activeGame === 'SUPER_LOTTO') {
          if (isPkg800) {
             pickedZone2 = [1,2,3,4,5,6,7,8]; 
          } else {
            const pool2 = getPoolByStrategy(stats.superLotto2, 1, strategy); 
            const finalPool2 = pool2.length < 1 ? stats.superLotto2.map(i=>i.number) : pool2;
            pickedZone2 = pickRandom(finalPool2, 1);
          }
        }

        newResults.push({
          zone1: pickedZone1,
          zone2: pickedZone2,
          type: typeConfig.id === 'pkg800' ? 'pkg800' : 'standard'
        });
      }

      setResults(newResults);
      setIsAnimating(false);
    }, 600);
  };

  // --- Gemini API Logic ---
  const handleDreamInterpret = async () => {
    if (!dreamText.trim()) return;
    setIsDreaming(true);
    setDreamError('');
    setResults([]);

    const gameName = GAMES[activeGame].name;
    const rules = activeGame === 'BIG_LOTTO' 
      ? 'Pick 6 unique numbers from 1-49. No special zone.' 
      : 'Pick 6 unique numbers from 1-38 (zone 1) and 1 number from 1-8 (zone 2).';

    const prompt = `
      You are a cyberpunk oracle AI. A user is asking for lucky lottery numbers based on a dream or inspiration.
      Game: ${gameName}
      Rules: ${rules}
      User Input: "${dreamText}"
      
      Task:
      1. Analyze the user's input for symbolism, keywords, or vibes.
      2. Generate a valid set of numbers for the game.
      3. Write a short, mystical, cool interpretation in Traditional Chinese (Taiwan). Keep it under 30 words.
      
      Response Format (JSON ONLY):
      {
        "zone1": [array of numbers],
        "zone2": [array of numbers (if applicable, else empty array)],
        "comment": "your interpretation here"
      }
    `;

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
          })
        }
      );

      if (!response.ok) throw new Error('Oracle disconnected');
      
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (!text) throw new Error('No prophecy received');

      const prediction = JSON.parse(text);

      setResults([{
        zone1: prediction.zone1,
        zone2: prediction.zone2 || [],
        type: 'dream',
        comment: prediction.comment
      }]);
      
      setShowDreamInput(false);
    } catch (err) {
      console.error(err);
      setDreamError('é€£çµç¥è«­å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    } finally {
      setIsDreaming(false);
    }
  };

  const copyToClipboard = () => {
    const text = results.map((r, i) => {
      const z1 = r.zone1.sort((a,b)=>a-b).join(', ');
      const z2 = r.type === 'pkg800' ? 'å…¨åŒ…' : r.zone2.join(', ');
      return `[${GAMES[activeGame].name}] ${r.comment ? `(${r.comment}) ` : ''}è™Ÿç¢¼: ${z1} ${activeGame === 'SUPER_LOTTO' ? `+ ${z2}` : ''}`;
    }).join('\n');
    
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      alert('è™Ÿç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼ç¥ä½ ä¸­å¤§çï¼');
    } catch (err) {
      console.error('Copy failed', err);
    }
    document.body.removeChild(textArea);
  };

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 font-sans selection:bg-cyan-500 selection:text-black pb-10">
      
      {/* Header */}
      <header className="p-6 border-b border-zinc-800 bg-zinc-900/50 backdrop-blur-md sticky top-0 z-50">
        <div className="max-w-3xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-zinc-800 p-2 rounded-lg border border-zinc-700 shadow-[0_0_15px_rgba(6,182,212,0.3)]">
              <Zap className="w-6 h-6 text-cyan-400" />
            </div>
            <div>
              <h1 className="text-2xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-500 drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                LOTTO.FUNK
              </h1>
              <p className="text-xs text-zinc-500 font-mono tracking-widest uppercase">AI-Enhanced Probability Generator</p>
            </div>
          </div>
          <a href="#" className="text-xs font-mono text-zinc-600 hover:text-cyan-400 transition-colors">v1.1.0 AI</a>
        </div>
      </header>

      <main className="max-w-3xl mx-auto p-4 sm:p-6 space-y-8">
        
        {/* Game Selector */}
        <section className="grid grid-cols-2 gap-4">
          {Object.keys(GAMES).map(key => (
            <button
              key={key}
              onClick={() => { setActiveGame(key); setGenType(1); setResults([]); }}
              className={`
                relative h-24 rounded-2xl border-2 transition-all duration-300 overflow-hidden group
                ${activeGame === key 
                  ? `border-transparent ring-2 ring-offset-2 ring-offset-zinc-950 ${key === 'BIG_LOTTO' ? 'ring-yellow-500' : 'ring-pink-500'}` 
                  : 'border-zinc-800 hover:border-zinc-600'}
              `}
            >
              <div className={`absolute inset-0 bg-gradient-to-br ${GAMES[key].color} opacity-10 group-hover:opacity-20 transition-opacity`} />
              <div className="relative z-10 flex flex-col items-center justify-center h-full gap-2">
                <span className={`text-xl font-black tracking-widest ${activeGame === key ? 'text-white drop-shadow-md' : 'text-zinc-500'}`}>
                  {GAMES[key].name}
                </span>
                <span className="text-[10px] font-mono bg-black/30 px-2 py-1 rounded text-zinc-300">
                  {key === 'BIG_LOTTO' ? '49å–6' : '38å–6 + 8å–1'}
                </span>
              </div>
            </button>
          ))}
        </section>

        {/* Controls Container */}
        <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 sm:p-6 space-y-6 shadow-2xl shadow-black relative overflow-hidden">
          
          {/* Main Controls Overlay (Hidden when dreaming) */}
          <div className={`transition-all duration-500 ${showDreamInput ? 'opacity-10 blur-sm pointer-events-none' : 'opacity-100'}`}>
            
            {/* Strategy Section */}
            <div>
              <div className="flex items-center gap-2 mb-3 text-zinc-400 text-sm font-mono uppercase tracking-widest">
                <TrendingUp className="w-4 h-4" /> æ¼”ç®—æ³•ç­–ç•¥
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                {STRATEGIES.map(s => {
                  const Icon = s.icon;
                  return (
                    <NeonButton 
                      key={s.id} 
                      active={strategy === s.id} 
                      onClick={() => setStrategy(s.id)}
                      className="text-xs sm:text-xs py-3"
                      colorClass="border-purple-400 text-purple-400"
                    >
                      <Icon className="w-3 h-3 mb-1 sm:mb-0 sm:mr-1 inline" />
                      <span className="block sm:inline">{s.name}</span>
                    </NeonButton>
                  );
                })}
              </div>
            </div>

            {/* Type Section */}
            <div className="mt-6">
              <div className="flex items-center gap-2 mb-3 text-zinc-400 text-sm font-mono uppercase tracking-widest">
                <Layers className="w-4 h-4" /> çµ„åˆæ¨¡å¼
              </div>
              <div className="flex flex-wrap gap-2">
                {GENERATION_TYPES[activeGame].map(t => (
                  <NeonButton 
                    key={t.id} 
                    active={genType === t.id} 
                    onClick={() => setGenType(t.id)}
                    colorClass={t.special ? "border-yellow-400 text-yellow-400" : "border-cyan-400 text-cyan-400"}
                    className="flex-grow sm:flex-grow-0"
                  >
                    {t.name}
                  </NeonButton>
                ))}
              </div>
            </div>

            {/* Action Buttons */}
            <div className="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-3">
               <button
                onClick={handleGenerate}
                disabled={isAnimating}
                className="col-span-1 sm:col-span-2 py-4 bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-600 rounded-xl font-black text-white text-xl tracking-widest uppercase hover:opacity-90 active:scale-[0.98] transition-all shadow-[0_0_20px_rgba(8,145,178,0.4)] disabled:opacity-50 disabled:cursor-not-allowed group relative overflow-hidden"
              >
                <span className="relative z-10 flex items-center justify-center gap-3">
                  {isAnimating ? <RefreshCw className="animate-spin" /> : <Sparkles />}
                  {isAnimating ? 'CALCULATING...' : 'GENERATE'}
                </span>
                <div className="absolute top-0 left-0 w-full h-1/2 bg-white/10" />
              </button>

              <button
                onClick={() => { setShowDreamInput(true); setResults([]); }}
                className="col-span-1 py-4 bg-zinc-800 border-2 border-purple-500/50 rounded-xl font-bold text-purple-300 tracking-widest uppercase hover:bg-purple-900/20 hover:border-purple-400 hover:text-white transition-all active:scale-95 flex items-center justify-center gap-2 group"
              >
                <BrainCircuit className="w-5 h-5 group-hover:text-purple-200" />
                <span className="text-sm">âœ¨ AI è§£å¤¢</span>
              </button>
            </div>
          </div>

          {/* Dream Input Overlay */}
          <div className={`absolute inset-0 bg-zinc-900 z-10 p-6 flex flex-col transition-transform duration-300 ${showDreamInput ? 'translate-y-0' : 'translate-y-full'}`}>
             <div className="flex items-center justify-between mb-4">
               <h3 className="text-lg font-bold text-purple-400 flex items-center gap-2">
                 <BrainCircuit className="w-5 h-5" />
                 AI éˆæ„Ÿè§£å¤¢å¸«
               </h3>
               <button onClick={() => setShowDreamInput(false)} className="text-zinc-500 hover:text-white">
                 <X className="w-6 h-6" />
               </button>
             </div>
             
             <p className="text-xs text-zinc-400 mb-2">è¼¸å…¥ä½ çš„å¤¢å¢ƒã€é¡˜æœ›æˆ–ç›´è¦ºé—œéµå­—ï¼Œè®“ AI ç‚ºä½ åˆ†æå¹¸é‹è™Ÿç¢¼ã€‚</p>
             
             <textarea 
               value={dreamText}
               onChange={(e) => setDreamText(e.target.value)}
               placeholder="ä¾‹ï¼šæˆ‘çœ‹è¦‹ä¸€éš»ç™¼å…‰çš„é‡‘è‰²çƒé¾œæ¸¸å‘å¤§æµ·..."
               className="flex-grow bg-zinc-950 border border-zinc-700 rounded-xl p-3 text-zinc-100 placeholder-zinc-600 focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500 resize-none text-sm"
             />

             {dreamError && <p className="text-red-400 text-xs mt-2">{dreamError}</p>}

             <button
                onClick={handleDreamInterpret}
                disabled={isDreaming || !dreamText.trim()}
                className="mt-4 w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold text-white tracking-widest hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {isDreaming ? <RefreshCw className="animate-spin w-4 h-4" /> : <Sparkles className="w-4 h-4" />}
                {isDreaming ? 'è§£è®€ç¥è«­ä¸­...' : 'é–‹å§‹è§£æ'}
              </button>
          </div>
        </div>

        {/* Results Area */}
        {results.length > 0 && (
          <div className="animate-in slide-in-from-bottom-10 fade-in duration-500">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-white flex items-center gap-2">
                <span className={`w-2 h-8 rounded-full inline-block animate-pulse ${results[0].type === 'dream' ? 'bg-purple-500' : 'bg-cyan-500'}`} />
                {results[0].type === 'dream' ? 'ç¥è«­çµæœ' : 'ç”Ÿæˆçš„è™Ÿç¢¼'}
              </h2>
              <button 
                onClick={copyToClipboard}
                className="flex items-center gap-2 text-sm text-zinc-400 hover:text-white transition-colors"
              >
                <Copy className="w-4 h-4" /> è¤‡è£½å…¨éƒ¨
              </button>
            </div>

            <div className="space-y-3">
              {results.map((res, idx) => (
                <ResultCard 
                  key={idx} 
                  result={res} 
                  index={idx} 
                  gameType={activeGame} 
                />
              ))}
            </div>

            <div className="mt-8 p-4 bg-zinc-900/50 border border-zinc-800 rounded-lg text-center">
              <p className="text-zinc-500 text-xs font-mono">
                DISCLAIMER: This app uses simulated data and AI generation. <br/>
                Gambling involves risk. Please play responsibly. <br/>
                æ­¤æ‡‰ç”¨ç¨‹å¼åƒ…ä¾›å¨›æ¨‚ï¼Œä¸ä¿è­‰ä¸­çã€‚
              </p>
            </div>
          </div>
        )}

      </main>
    </div>
  );
}
